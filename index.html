<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Discourse // Unnamed Things</title>
    <link rel="icon" type="image/jpeg" href="https://i.ibb.co/0jxSvdfH/channels4-profile.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400&family=Special+Elite&display=swap" rel="stylesheet">
    
    <style>
        :root { --color-red: #CD201F; --color-black: #050505; --color-gray: #1a1a1a; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--color-black);
            color: #e0e0e0;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        /* NAVBAR (Simplified for Forum) */
        .navbar {
            background: rgba(10,10,10,0.95); border-bottom: 1px solid #333;
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px);
        }
        .nav-brand { font-family: 'Oswald'; font-size: 1.2rem; color: #fff; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-brand span { color: var(--color-red); }
        .nav-logo { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--color-red); }

        /* MAIN LAYOUT */
        .container { max-width: 1000px; margin: 0 auto; padding: 2rem 5%; }
        
        /* VIEWS */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* HEADER & CONTROLS */
        .forum-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem; border-bottom: 2px solid #333; padding-bottom: 1rem; }
        h1 { font-family: 'Oswald'; font-size: 2rem; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
        .subtitle { font-family: 'Special Elite'; color: #666; font-size: 0.9rem; margin-top: 5px; }

        .btn-create {
            background: var(--color-red); color: #fff; border: none; padding: 10px 20px;
            font-family: 'Oswald'; text-transform: uppercase; cursor: pointer; transition: all 0.3s;
        }
        .btn-create:hover { background: #ff3333; box-shadow: 0 0 15px rgba(205,32,31,0.4); }

        /* THREAD LIST */
        .thread-item {
            background: #111; border: 1px solid #333; padding: 1.5rem; margin-bottom: 1rem;
            transition: all 0.2s; cursor: pointer; display: flex; justify-content: space-between;
        }
        .thread-item:hover { border-color: var(--color-red); transform: translateX(5px); }
        .thread-main h3 { font-family: 'Oswald'; font-size: 1.3rem; margin-bottom: 5px; color: #fff; }
        .thread-meta { font-family: 'Special Elite'; font-size: 0.8rem; color: #666; }
        .thread-stats { text-align: right; color: #444; font-family: 'Special Elite'; font-size: 0.8rem; }

        /* SINGLE THREAD VIEW */
        .thread-view-header { background: #111; padding: 2rem; border: 1px solid #333; margin-bottom: 2rem; }
        .op-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .op-avatar { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #333; }
        .op-body { font-size: 1.1rem; line-height: 1.6; white-space: pre-wrap; color: #ddd; }
        .btn-back { background: none; border: 1px solid #333; color: #888; padding: 5px 15px; cursor: pointer; margin-bottom: 1rem; font-family: 'Special Elite'; }
        .btn-back:hover { color: #fff; border-color: #fff; }

        /* COMMENTS (Simplified for brevity) */
        .comment-feed { margin-top: 2rem; border-top: 1px dashed #333; padding-top: 2rem; }
        .comment-item { margin-bottom: 1.5rem; border-left: 2px solid #333; padding-left: 1rem; }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-box { width: 90%; max-width: 600px; background: #0a0a0a; border: 1px solid var(--color-red); padding: 2rem; }
        input, textarea { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 10px; margin-bottom: 1rem; font-family: 'Roboto'; }
        input:focus, textarea:focus { border-color: var(--color-red); outline: none; }

        /* LOGIN GATE */
        .login-gate { text-align: center; padding: 4rem; border: 1px dashed #333; margin-top: 2rem; display: none; }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="https://unnamedthings07.qzz.io" class="nav-brand">
            <img src="https://i.ibb.co/0jxSvdfH/channels4-profile.jpg" class="nav-logo">
            <span>U</span>nnamed <span>T</span>hings // FORUMS
        </a>
        <div id="userWidget">
            <button id="navLoginBtn" class="btn-create" style="background:#333;">LOGIN</button>
            <div id="navProfile" style="display:none; color:#fff; font-family:'Oswald';">AGENT_ID</div>
        </div>
    </nav>

    <div class="container">
        
        <div id="viewList" class="view-section active">
            <div class="forum-header">
                <div>
                    <h1>Public Terminals</h1>
                    <div class="subtitle">SECURE CHANNELS FOR DISCUSSION & THEORY</div>
                </div>
                <button id="btnOpenCreate" class="btn-create">+ NEW TRANSMISSION</button>
            </div>
            
            <div id="threadList">
                <div style="text-align:center; padding:3rem; color:#666; font-family:'Special Elite';">LOADING FREQUENCIES...</div>
            </div>
        </div>

        <div id="viewThread" class="view-section">
            <button id="btnBack" class="btn-back">&larr; RETURN TO INDEX</button>
            
            <div class="thread-view-header">
                <h1 id="threadTitle">Loading...</h1>
                <div class="op-meta">
                    <img id="threadAvatar" src="" class="op-avatar">
                    <div>
                        <div id="threadAuthor" style="font-family:'Oswald'; color:var(--color-red);">UNKNOWN</div>
                        <div id="threadDate" style="font-size:0.8rem; color:#666;">---</div>
                    </div>
                </div>
                <div id="threadBody" class="op-body"></div>
            </div>

            <h3>RESPONSES</h3>
            <div class="login-gate" id="commentLoginGate">
                AUTHENTICATION REQUIRED TO RESPOND
            </div>
            <div id="replyBox" style="margin-top:1rem; display:none;">
                <textarea id="replyInput" rows="3" placeholder="Enter transmission..."></textarea>
                <button id="btnSubmitReply" class="btn-create">SEND</button>
            </div>
            <div id="commentsFeed" class="comment-feed"></div>
        </div>

    </div>

    <div id="createModal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="font-family:'Oswald'; color:#fff; margin-bottom:1rem;">NEW TRANSMISSION</h2>
            <input type="text" id="newTitle" placeholder="SUBJECT / TITLE">
            <textarea id="newBody" rows="6" placeholder="MESSAGE CONTENT..."></textarea>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="btnCancelCreate" style="background:transparent; border:1px solid #333; color:#fff; padding:10px 20px; cursor:pointer;">CANCEL</button>
                <button id="btnSubmitThread" class="btn-create">BROADCAST</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwIMRuv26pcAndpd36EkLbUpSGvh6ptSY",
            authDomain: "unnamed-things-website-70cf7.firebaseapp.com",
            projectId: "unnamed-things-website-70cf7",
            storageBucket: "unnamed-things-website-70cf7.firebasestorage.app",
            messagingSenderId: "293788800527",
            appId: "1:293788800527:web:575a1fd1f60d6361f3357a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUser = null;

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if(user) {
                document.getElementById('navLoginBtn').style.display = 'none';
                document.getElementById('navProfile').style.display = 'block';
                document.getElementById('navProfile').innerText = (user.displayName || "AGENT").toUpperCase();
                
                document.getElementById('replyBox').style.display = 'block';
                document.getElementById('commentLoginGate').style.display = 'none';
            } else {
                document.getElementById('navLoginBtn').style.display = 'block';
                document.getElementById('navProfile').style.display = 'none';
                
                document.getElementById('replyBox').style.display = 'none';
                document.getElementById('commentLoginGate').style.display = 'block';
            }
        });

        document.getElementById('navLoginBtn').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider());
        });

        // --- ROUTING ---
        function checkUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const threadId = urlParams.get('t');
            if(threadId) {
                loadThread(threadId);
            } else {
                showList();
            }
        }
        window.addEventListener('popstate', checkUrl);

        function showList() {
            document.getElementById('viewList').classList.add('active');
            document.getElementById('viewThread').classList.remove('active');
            loadAllThreads();
        }

        // --- THREAD LIST ---
        async function loadAllThreads() {
            const list = document.getElementById('threadList');
            const q = query(collection(db, "threads"), orderBy("timestamp", "desc"));
            
            // Real-time listener
            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";
                if(snapshot.empty) {
                    list.innerHTML = "<div style='text-align:center; padding:3rem; color:#444;'>NO TRANSMISSIONS DETECTED.</div>";
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : "---";
                    
                    const item = document.createElement('div');
                    item.className = 'thread-item';
                    item.innerHTML = `
                        <div class="thread-main">
                            <h3>${data.title}</h3>
                            <div class="thread-meta">BY ${data.author} // ${date}</div>
                        </div>
                        <div class="thread-stats">
                            OPEN FILE &rarr;
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        history.pushState({}, '', `?t=${doc.id}`);
                        loadThread(doc.id);
                    });
                    list.appendChild(item);
                });
            });
        }

        // --- SINGLE THREAD ---
        let currentThreadId = null;

        async function loadThread(id) {
            currentThreadId = id;
            document.getElementById('viewList').classList.remove('active');
            document.getElementById('viewThread').classList.add('active');
            
            // Load Content
            const docRef = doc(db, "threads", id);
            const docSnap = await getDoc(docRef);
            
            if(docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('threadTitle').innerText = data.title;
                document.getElementById('threadAuthor').innerText = data.author;
                document.getElementById('threadBody').innerText = data.body;
                document.getElementById('threadAvatar').src = data.photo || "https://i.ibb.co/0jxSvdfH/channels4-profile.jpg";
                document.getElementById('threadDate').innerText = data.timestamp ? data.timestamp.toDate().toLocaleString() : "";
                
                loadComments(id);
            }
        }

        document.getElementById('btnBack').addEventListener('click', () => {
            history.pushState({}, '', window.location.pathname);
            showList();
        });

        // --- COMMENTS (Simplified) ---
        function loadComments(threadId) {
            const feed = document.getElementById('commentsFeed');
            const q = query(collection(db, "comments"), where("threadId", "==", threadId), orderBy("timestamp", "asc"));
            
            onSnapshot(q, (snapshot) => {
                feed.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `
                        <div style="color:var(--color-red); font-family:'Oswald'; font-size:0.9rem;">${data.author}</div>
                        <div style="color:#ccc; margin-top:5px;">${data.text}</div>
                    `;
                    feed.appendChild(div);
                });
            });
        }

        document.getElementById('btnSubmitReply').addEventListener('click', async () => {
            const text = document.getElementById('replyInput').value;
            if(!text || !currentUser) return;
            
            await addDoc(collection(db, "comments"), {
                threadId: currentThreadId,
                text: text,
                author: currentUser.displayName || "AGENT",
                uid: currentUser.uid,
                timestamp: serverTimestamp()
            });
            document.getElementById('replyInput').value = "";
        });

        // --- CREATE NEW THREAD ---
        const modal = document.getElementById('createModal');
        document.getElementById('btnOpenCreate').addEventListener('click', () => {
            if(!currentUser) { alert("LOGIN REQUIRED"); return; }
            modal.style.display = 'flex';
        });
        document.getElementById('btnCancelCreate').addEventListener('click', () => modal.style.display = 'none');
        
        document.getElementById('btnSubmitThread').addEventListener('click', async () => {
            const title = document.getElementById('newTitle').value;
            const body = document.getElementById('newBody').value;
            
            if(title && body && currentUser) {
                await addDoc(collection(db, "threads"), {
                    title: title,
                    body: body,
                    author: currentUser.displayName || "AGENT",
                    uid: currentUser.uid,
                    photo: currentUser.photoURL,
                    timestamp: serverTimestamp()
                });
                modal.style.display = 'none';
                document.getElementById('newTitle').value = "";
                document.getElementById('newBody').value = "";
            }
        });

        // Init
        checkUrl();
    </script>
</body>
</html>
